# Case 2: Using the Gateway as Middleware for READ_AND_WRITE in EVM-based blockchains

This test case demonstrates how the Gateway can act as a middleware to support READ and WRITE operations on 2 EVM-based blockchains. It builds on the previous example (case 1) by introducing a more dynamic interaction flow, where contract state is read and immediately written to another blockchain. Contrarily to the previous case, this test case does not require a separate request to trigger the contract functions. Instead, it directly interacts with the EVM-based blockchain through the Gateway.

For this, we will use the `OracleTestContract` contract, which is a simple contract that allows us to store and retrieve data. The contract has two functions:

* **`setData(string memory data)`** – Stores data on-chain and associates it with a `bytes32` ID.
* **`getData(bytes32 id)`** – Retrieves data from the contract by its ID.


## Terminal Overview

Before starting, here is a summary of what each terminal will be used for in this case:

- **Terminal 1:** Run the Gateway (Docker Compose)
- **Terminal 2:** Start Hardhat EVM Blockchain 1 (port 8545)
- **Terminal 3:** Start Hardhat EVM Blockchain 2 (port 8546)
- **Terminal 4:** Deploy the OracleTestContract smart contract to both blockchains
- **Terminal 5:** Run the Oracle interaction script (read/write via Gateway)

This pattern is similar in other Oracle cases:
- **Gateway terminal** (usually Terminal 1): Always run the Gateway via Docker Compose
- **EVM/Hardhat terminals** (usually Terminals 2, 3): Start one or more local blockchains
- **Deployment/Script terminals** (Terminals 4+): Deploy contracts and run interaction scripts

Refer to each case's README for the exact mapping and steps.

## Setup Instructions

### 1. Start the Gateway (Docker)

In terminal 1, from this directory:

```bash
docker compose up
```

This will start the Gateway with the corresponding configuration file located in `./config/config-oracle-2-evm-requests.json`.



### 2. Start the Hardhat EVM Blockchains

In terminal 2, from this directory, run:

```bash
cd ../../../EVM && npx hardhat node --hostname 0.0.0.0 --port 8545
```

In terminal 3, from this directory, run:

```bash
cd ../../../EVM && npx hardhat node --hostname 0.0.0.0 --port 8546
```

> ⚠️ Make sure to use `--hostname 0.0.0.0` on both cases so that the Gateway (inside Docker) can access the local Hardhat node.



### 3. Deploy the Smart Contract

In terminal 4, from this directory, run:

```bash
cd ../../../EVM && npx hardhat ignition deploy ./ignition/modules/OracleTestContract.js --network hardhat1
cd ../../../EVM && npx hardhat ignition deploy ./ignition/modules/OracleTestContract.js --network hardhat2
```

> This deploys the `OracleTestContract` to the running Hardhat networks (`hardhat1` and `hardhat2` should be configured in `hardhat.config.js` to point to `http://0.0.0.0:8545` and `http://0.0.0.0:8546` respectively).



### 4. Run the Oracle Interaction Script

In terminal 5, from this directory (`gateway/oracle/case_2`):

```bash
python3 oracle-execute-auto-read-and-write.py
```

> This script sends POST requests to the Gateway to trigger contract `setData` and `getData` functions via `/oracle/execute`.

---

## Result

Check the logs in terminal 5 where you executed the `oracle-execute-auto-read-and-write.py` script. You should see the following:
1. The response from the Gateway confirming the read and write task.
2. The response from the Gateway confirming the read result from the second EVM-based blockchain (i.e., to where the data was written to), returning the data that was set in the first EVM-based blockchain in the form:

```json
...
{'output': 'DATA WRITTEN TO THE BLOCKCHAIN'}
...
```

Also check the logs in terminals 2 and 3 where you started the Hardhat nodes. You should see logs confirming the read operation and the transaction (write) to the second EVM-based blockchain.


Finally, you can access the `./satp-hermes-gateway/logs/` directory (relative to this case folder) to see the logs generated by the Gateway. The logs will contain detailed information about the requests and responses, including any errors or warnings that may have occurred during the process.
